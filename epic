#!/usr/bin/env node

const { spawn } = require("child_process");
const path = require("path");

// Helper function to run commands safely
function runCommand(command, args = [], options = {}) {
  return new Promise((resolve, reject) => {
    const child = spawn(command, args, {
      stdio: "inherit",
      ...options,
    });

    child.on("close", (code) => {
      if (code === 0) {
        resolve();
      } else {
        reject(new Error(`Command failed with exit code ${code}`));
      }
    });

    child.on("error", (error) => {
      reject(error);
    });
  });
}

// Run command
async function run(container) {
  try {
    console.log(`ğŸš€ Running Docker container: ${container ?? ""}`);
    await runCommand("node", ["scripts/run.js", container ?? ""]);
    console.log(`âœ… Container ${container} running successfully!`);
  } catch (error) {
    console.error(`âŒ Container ${container} failed to run:`, error.message);
    process.exit(1);
  }
}

// Logs command
async function logs(container) {
  try {
    console.log(`ğŸš€ Logging container: ${container}`);
    await runCommand("node", ["scripts/logs.js", container]);
    console.log(`âœ… Logs ${container} completed successfully!`);
  } catch (error) {
    console.error(`âŒ Logs ${container} failed:`, error.message);
    process.exit(1);
  }
}

// List command
async function list() {
  try {
    console.log(`ğŸš€ Listing running containers...`);
    await runCommand("node", ["scripts/list.js"]);
  } catch (error) {
    console.error(`âŒ List failed:`, error.message);
    process.exit(1);
  }
}

// Inject command
async function inject(container) {
  try {
    console.log(`ğŸš€ Injecting into container: ${container}`);
    await runCommand("node", ["scripts/inject.js", container]);
  } catch (error) {
    console.error(`âŒ Inject failed:`, error.message);
    process.exit(1);
  }
}

// Build command
async function build(target) {
  if (!target || !["app", "api"].includes(target)) {
    console.error("âŒ Error: Target must be 'app' or 'api'");
    console.log("Usage: epic build [app|api]");
    process.exit(1);
  }

  try {
    console.log(`ğŸš€ Building ${target}...`);
    await runCommand("node", ["scripts/build.js", target]);
    console.log(`âœ… ${target} build completed successfully!`);
  } catch (error) {
    console.error(`âŒ ${target} build failed:`, error.message);
    process.exit(1);
  }
}

// Deploy command
async function deploy(action) {
  if (!action || !["apply", "delete"].includes(action)) {
    console.error("âŒ Error: Action must be 'apply' or 'delete'");
    console.log("Usage: epic deploy [apply|delete]");
    process.exit(1);
  }

  try {
    console.log(`ğŸš€ Deploying ${action}...`);
    await runCommand("node", ["scripts/deploy.js", action]);
    console.log(`âœ… Deploy ${action} completed successfully!`);
  } catch (error) {
    console.error(`âŒ Deploy ${action} failed:`, error.message);
    process.exit(1);
  }
}

// Remove command
async function remove(target) {
  try {
    console.log(`ğŸš€ Removing containers...`);
    const args = ["scripts/remove.js"];
    if (target) {
      args.push(target);
    }
    await runCommand("node", args);
  } catch (error) {
    console.error(`âŒ Remove failed:`, error.message);
    process.exit(1);
  }
}

// Main CLI logic
function main() {
  const args = process.argv.slice(2);
  const command = args[0];
  const target = args[1];

  switch (command) {
    case "build":
      build(target);
      break;
    case "deploy":
      deploy(target);
      break;
    case "run":
      run(target);
      break;
    case "logs":
      logs(target);
      break;
    case "list":
      list();
      break;
    case "inject":
      inject(target);
      break;
    case "remove":
      remove(target);
      break;
    case "help":
    case "--help":
    case "-h":
      showHelp();
      break;
    default:
      console.error("âŒ Error: Unknown command");
      showHelp();
      process.exit(1);
  }
}

// Help function
function showHelp() {
  console.log(`
ğŸ“¦ Epic Story CLI

Usage:
  epic build [app|api]         Build Docker images
  epic deploy [apply|delete]   Deploy to Kubernetes
  epic inject [container-name] Inject into a running container
  epic run                     Run Docker containers
  epic logs [container-name]   Log container output
  epic list                    List running containers
  epic remove                 Stop and remove all containers
  epic help                    Show this help message

Examples:
  epic build api              Build API Docker image
  epic build app              Build App Docker image
  epic deploy apply           Apply Kubernetes configurations
  epic deploy delete          Delete Kubernetes resources
  epic inject epicstory-api   Inject into a running container
  epic run                    Run Docker containers
  epic logs epicstory-api      Log container output
  epic list                   List running containers
  epic remove                 Stop and remove all containers
`);
}

// Run the CLI
main();

#!/usr/bin/env node

const { spawn } = require("child_process");
const path = require("path");

// Helper function to run commands safely
function runCommand(command, args = [], options = {}) {
  return new Promise((resolve, reject) => {
    const child = spawn(command, args, {
      stdio: "inherit",
      ...options,
    });

    child.on("close", (code) => {
      if (code === 0) {
        resolve();
      } else {
        reject(new Error(`Command failed with exit code ${code}`));
      }
    });

    child.on("error", (error) => {
      reject(error);
    });
  });
}

// Get the absolute path to the scripts directory
const scriptsDir = path.join(__dirname, "scripts");
const apiDir = path.join(__dirname, "api");

function takeFlagValue(args, flagLong, flagShort) {
  const idxLong = flagLong ? args.indexOf(flagLong) : -1;
  const idxShort = flagShort ? args.indexOf(flagShort) : -1;
  const idx =
    idxLong !== -1 ? idxLong : idxShort !== -1 ? idxShort : -1;
  if (idx === -1) return { value: undefined, rest: args };

  const next = args[idx + 1];
  if (next == null || next.startsWith("-")) {
    return { value: undefined, rest: args.filter((_, i) => i !== idx) };
  }
  const rest = args.filter((_, i) => i !== idx && i !== idx + 1);
  return { value: next, rest };
}

function takeEqualsFlagValue(args, flagLong) {
  if (!flagLong) return { value: undefined, rest: args };
  const prefix = `${flagLong}=`;
  const match = args.find((a) => a.startsWith(prefix));
  if (!match) return { value: undefined, rest: args };
  const value = match.slice(prefix.length);
  const rest = args.filter((a) => a !== match);
  return { value, rest };
}

// Run command
async function run(container) {
  try {
    console.log(`üöÄ Running Docker container: ${container ?? ""}`);
    await runCommand("node", [path.join(scriptsDir, "run.js"), container ?? ""]);
    console.log(`‚úÖ Container ${container} running successfully!`);
  } catch (error) {
    console.error(`‚ùå Container ${container} failed to run:`, error.message);
    process.exit(1);
  }
}

// Logs command
async function logs(container) {
  try {
    console.log(`üöÄ Logging container: ${container}`);
    await runCommand("node", [path.join(scriptsDir, "logs.js"), container]);
    console.log(`‚úÖ Logs ${container} completed successfully!`);
  } catch (error) {
    console.error(`‚ùå Logs ${container} failed:`, error.message);
    process.exit(1);
  }
}

// List command
async function list() {
  try {
    console.log(`üöÄ Listing running containers...`);
    await runCommand("node", [path.join(scriptsDir, "list.js")]);
  } catch (error) {
    console.error(`‚ùå List failed:`, error.message);
    process.exit(1);
  }
}

// Inject command
async function inject(container) {
  try {
    console.log(`üöÄ Injecting into container: ${container}`);
    await runCommand("node", [path.join(scriptsDir, "inject.js"), container]);
  } catch (error) {
    console.error(`‚ùå Inject failed:`, error.message);
    process.exit(1);
  }
}

// Build command
async function build(target) {
  if (!target || !["app", "api"].includes(target)) {
    console.error("‚ùå Error: Target must be 'app' or 'api'");
    console.log("Usage: epic build [app|api]");
    process.exit(1);
  }

  try {
    console.log(`üöÄ Building ${target}...`);
    await runCommand("node", [path.join(scriptsDir, "build.js"), target]);
    console.log(`‚úÖ ${target} build completed successfully!`);
  } catch (error) {
    console.error(`‚ùå ${target} build failed:`, error.message);
    process.exit(1);
  }
}

// Deploy command
async function deploy(action) {
  if (!action || !["apply", "delete"].includes(action)) {
    console.error("‚ùå Error: Action must be 'apply' or 'delete'");
    console.log("Usage: epic deploy [apply|delete]");
    process.exit(1);
  }

  try {
    console.log(`üöÄ Deploying ${action}...`);
    await runCommand("node", [path.join(scriptsDir, "deploy.js"), action]);
    console.log(`‚úÖ Deploy ${action} completed successfully!`);
  } catch (error) {
    console.error(`‚ùå Deploy ${action} failed:`, error.message);
    process.exit(1);
  }
}

// Remove command
async function remove(target) {
  try {
    console.log(`üöÄ Removing containers...`);
    const args = [path.join(scriptsDir, "remove.js")];
    if (target) {
      args.push(target);
    }
    await runCommand("node", args);
  } catch (error) {
    console.error(`‚ùå Remove failed:`, error.message);
    process.exit(1);
  }
}

async function migrations(action, args = []) {
  try {
    if (!action || !["generate", "run", "revert"].includes(action)) {
      console.error("‚ùå Error: Action must be 'generate', 'run', or 'revert'");
      console.log(
        'Usage: epic migrations generate --name="..." | epic migrations run | epic migrations revert',
      );
      process.exit(1);
    }

    if (action === "generate") {
      // Support:
      // - epic migrations generate --name Foo
      // - epic migrations generate --name=Foo
      // - epic migrations generate Foo
      const eq = takeEqualsFlagValue(args, "--name");
      const spaced = takeFlagValue(eq.rest, "--name", "-n");
      let name = eq.value ?? spaced.value;
      let rest = spaced.rest;
      if (!name && rest[0] && !rest[0].startsWith("-")) {
        name = rest[0];
        rest = rest.slice(1);
      }
      if (!name) {
        console.error('‚ùå Error: Missing migration name (use --name="...")');
        console.log('Usage: epic migrations generate --name="AddFooBar"');
        process.exit(1);
      }

      console.log(`üöÄ Generating migration: ${name}`);
      const npmArgs = ["run", "migrations:generate"];
      if (rest.length > 0) npmArgs.push("--", ...rest);

      await runCommand("npm", npmArgs, {
        cwd: apiDir,
        env: { ...process.env, npm_config_name: name },
      });
      console.log("‚úÖ Migration generated successfully!");
      return;
    }

    if (action === "run") {
      console.log("üöÄ Running migrations...");
      const npmArgs = ["run", "migrations:run"];
      if (args.length > 0) npmArgs.push("--", ...args);
      await runCommand("npm", npmArgs, { cwd: apiDir });
      console.log("‚úÖ Migrations ran successfully!");
      return;
    }

    if (action === "revert") {
      console.log("üöÄ Reverting last migration...");
      const npmArgs = ["run", "migrations:revert"];
      if (args.length > 0) npmArgs.push("--", ...args);
      await runCommand("npm", npmArgs, { cwd: apiDir });
      console.log("‚úÖ Migration reverted successfully!");
      return;
    }
  } catch (error) {
    console.error(`‚ùå Migrations ${action} failed:`, error.message);
    process.exit(1);
  }
}

// Main CLI logic
function main() {
  const args = process.argv.slice(2);
  const [command, ...rest] = args;
  const target = rest[0];

  switch (command) {
    case "build":
      build(target);
      break;
    case "deploy":
      deploy(target);
      break;
    case "run":
      run(target);
      break;
    case "logs":
      logs(target);
      break;
    case "list":
      list();
      break;
    case "inject":
      inject(target);
      break;
    case "remove":
      remove(target);
      break;
    case "migrations":
      migrations(rest[0], rest.slice(1));
      break;
    case "help":
    case "--help":
    case "-h":
      showHelp();
      break;
    default:
      console.error("‚ùå Error: Unknown command");
      showHelp();
      process.exit(1);
  }
}

// Help function
function showHelp() {
  console.log(`
üì¶ Epic Story CLI

Usage:
  epic build [app|api]         Build Docker images
  epic deploy [apply|delete]   Deploy to Kubernetes
  epic inject [container-name] Inject into a running container
  epic run                     Run Docker containers
  epic logs [container-name]   Log container output
  epic list                    List running containers
  epic remove                 Stop and remove all containers
  epic migrations <command>    Manage API database migrations
  epic help                    Show this help message

Examples:
  epic build api              Build API Docker image
  epic build app              Build App Docker image
  epic deploy apply           Apply Kubernetes configurations
  epic deploy delete          Delete Kubernetes resources
  epic inject epicstory-api   Inject into a running container
  epic run                    Run Docker containers
  epic logs epicstory-api      Log container output
  epic list                   List running containers
  epic remove                 Stop and remove all containers
  epic migrations generate --name="AddFooBar"
  epic migrations run
  epic migrations revert
`);
}

// Run the CLI
main();

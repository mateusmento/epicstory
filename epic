#!/usr/bin/env node

const { spawn } = require("child_process");
const path = require("path");

// Helper function to run commands safely
function runCommand(command, args = [], options = {}) {
  return new Promise((resolve, reject) => {
    const child = spawn(command, args, {
      stdio: "inherit",
      ...options,
    });

    child.on("close", (code) => {
      if (code === 0) {
        resolve();
      } else {
        reject(new Error(`Command failed with exit code ${code}`));
      }
    });

    child.on("error", (error) => {
      reject(error);
    });
  });
}

// Get the absolute path to the scripts directory
const scriptsDir = path.join(__dirname, "scripts");

// Run command
async function run(container) {
  try {
    console.log(`üöÄ Running Docker container: ${container ?? ""}`);
    await runCommand("node", [path.join(scriptsDir, "run.js"), container ?? ""]);
    console.log(`‚úÖ Container ${container} running successfully!`);
  } catch (error) {
    console.error(`‚ùå Container ${container} failed to run:`, error.message);
    process.exit(1);
  }
}

// Logs command
async function logs(container) {
  try {
    console.log(`üöÄ Logging container: ${container}`);
    await runCommand("node", [path.join(scriptsDir, "logs.js"), container]);
    console.log(`‚úÖ Logs ${container} completed successfully!`);
  } catch (error) {
    console.error(`‚ùå Logs ${container} failed:`, error.message);
    process.exit(1);
  }
}

// List command
async function list() {
  try {
    console.log(`üöÄ Listing running containers...`);
    await runCommand("node", [path.join(scriptsDir, "list.js")]);
  } catch (error) {
    console.error(`‚ùå List failed:`, error.message);
    process.exit(1);
  }
}

// Inject command
async function inject(container) {
  try {
    console.log(`üöÄ Injecting into container: ${container}`);
    await runCommand("node", [path.join(scriptsDir, "inject.js"), container]);
  } catch (error) {
    console.error(`‚ùå Inject failed:`, error.message);
    process.exit(1);
  }
}

// Build command
async function build(target) {
  if (!target || !["app", "api"].includes(target)) {
    console.error("‚ùå Error: Target must be 'app' or 'api'");
    console.log("Usage: epic build [app|api]");
    process.exit(1);
  }

  try {
    console.log(`üöÄ Building ${target}...`);
    await runCommand("node", [path.join(scriptsDir, "build.js"), target]);
    console.log(`‚úÖ ${target} build completed successfully!`);
  } catch (error) {
    console.error(`‚ùå ${target} build failed:`, error.message);
    process.exit(1);
  }
}

// Deploy command
async function deploy(action) {
  if (!action || !["apply", "delete"].includes(action)) {
    console.error("‚ùå Error: Action must be 'apply' or 'delete'");
    console.log("Usage: epic deploy [apply|delete]");
    process.exit(1);
  }

  try {
    console.log(`üöÄ Deploying ${action}...`);
    await runCommand("node", [path.join(scriptsDir, "deploy.js"), action]);
    console.log(`‚úÖ Deploy ${action} completed successfully!`);
  } catch (error) {
    console.error(`‚ùå Deploy ${action} failed:`, error.message);
    process.exit(1);
  }
}

// Remove command
async function remove(target) {
  try {
    console.log(`üöÄ Removing containers...`);
    const args = [path.join(scriptsDir, "remove.js")];
    if (target) {
      args.push(target);
    }
    await runCommand("node", args);
  } catch (error) {
    console.error(`‚ùå Remove failed:`, error.message);
    process.exit(1);
  }
}

// Main CLI logic
function main() {
  const args = process.argv.slice(2);
  const command = args[0];
  const target = args[1];

  switch (command) {
    case "build":
      build(target);
      break;
    case "deploy":
      deploy(target);
      break;
    case "run":
      run(target);
      break;
    case "logs":
      logs(target);
      break;
    case "list":
      list();
      break;
    case "inject":
      inject(target);
      break;
    case "remove":
      remove(target);
      break;
    case "help":
    case "--help":
    case "-h":
      showHelp();
      break;
    default:
      console.error("‚ùå Error: Unknown command");
      showHelp();
      process.exit(1);
  }
}

// Help function
function showHelp() {
  console.log(`
üì¶ Epic Story CLI

Usage:
  epic build [app|api]         Build Docker images
  epic deploy [apply|delete]   Deploy to Kubernetes
  epic inject [container-name] Inject into a running container
  epic run                     Run Docker containers
  epic logs [container-name]   Log container output
  epic list                    List running containers
  epic remove                 Stop and remove all containers
  epic help                    Show this help message

Examples:
  epic build api              Build API Docker image
  epic build app              Build App Docker image
  epic deploy apply           Apply Kubernetes configurations
  epic deploy delete          Delete Kubernetes resources
  epic inject epicstory-api   Inject into a running container
  epic run                    Run Docker containers
  epic logs epicstory-api      Log container output
  epic list                   List running containers
  epic remove                 Stop and remove all containers
`);
}

// Run the CLI
main();
